
using Altinn.Broker.Application;
using Altinn.Broker.Core.Domain;
using Altinn.Broker.Core.Repositories;
using Altinn.Broker.Helpers;

using Azure.Messaging.EventGrid;
using Azure.Messaging.EventGrid.SystemEvents;

using Microsoft.AspNetCore.Mvc;

using Newtonsoft.Json;

using OneOf;

namespace Altinn.Broker.Webhooks.Controllers
{
    [ApiController]
    [Route("broker/api/v1/webhooks/malwarescanresults")]
    public class MalwareScanResultsController : Controller
    {
        private readonly IFileRepository _fileRepository;
        private readonly IFileStatusRepository _fileStatusRepository;
        private readonly IIdempotencyEventRepository _idempotencyEventRepository;

        public MalwareScanResultsController(IFileRepository fileRepository, IFileStatusRepository fileStatusRepository, IIdempotencyEventRepository idempotencyEventRepository)
        {
            _fileRepository = fileRepository;
            _fileStatusRepository = fileStatusRepository;
            _idempotencyEventRepository = idempotencyEventRepository;
        }

        [HttpPost]
        public async Task<ActionResult> ProcessMalwareScanResult([FromServices] MalwareScanningResultHandler handler, CancellationToken cancellationToken)
        {
            BinaryData events = BinaryData.FromStreamAsync(this.Request.Body).Result;
            EventGridEvent[] eventGridEvents = EventGridEvent.ParseMany(events);
            foreach (EventGridEvent eventGridEvent in eventGridEvents)
            {
                if (eventGridEvent.TryGetSystemEventData(out object eventData))
                {
                    if (eventData is SubscriptionValidationEventData subscriptionValidationEventData)
                    {
                        // TODO: validate that eventGridEvent WebHook subscription is actually from an Altinn Azure Defender EventGrid
                        var responseData = new
                        {
                            ValidationResponse = subscriptionValidationEventData.ValidationCode
                        };
                        return new OkObjectResult(responseData);
                    }
                }
                else if (eventGridEvent.EventType == "Microsoft.Security.MalwareScanningResult")
                {
                    string jsonString = eventGridEvent.Data.ToString();
                    ScanResultData result = JsonConvert.DeserializeObject<ScanResultData>(jsonString);
                    var processFunction = new Func<Task<OneOf<Task, Error>>>(() => handler.Process(result, cancellationToken));
                    var commandResult = await IdempotencyEventHelper.ProcessEvent(result.ETag, processFunction, _idempotencyEventRepository, cancellationToken);
                    return commandResult.Match(
                        Ok,
                        Problem
                    );

                }
            }

            return Ok();
        }
        private ObjectResult Problem(Error error) => Problem(detail: error.Message, statusCode: (int)error.StatusCode);
    }
}
