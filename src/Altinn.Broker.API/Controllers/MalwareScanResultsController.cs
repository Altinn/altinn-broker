
using Altinn.Broker.Application;
using Altinn.Broker.Core.Domain;
using Altinn.Broker.Helpers;


using Azure.Messaging.EventGrid;
using Azure.Messaging.EventGrid.SystemEvents;

using Microsoft.AspNetCore.Mvc;

using Newtonsoft.Json;

namespace Altinn.Broker.Webhooks.Controllers;

[ApiController]
[Route("broker/api/v1/webhooks/malwarescanresults")]
[ApiExplorerSettings(IgnoreApi = true)]
public class MalwareScanResultsController(ILogger<MalwareScanResultsController> logger) : Controller
{
    [HttpPost]
    [Consumes("application/json")]
    public async Task<ActionResult> ProcessMalwareScanResult([FromServices] MalwareScanningResultHandler handler, CancellationToken cancellationToken)
    {
        BinaryData events = await BinaryData.FromStreamAsync(this.Request.Body);
        EventGridEvent[] eventGridEvents = EventGridEvent.ParseMany(events);
        foreach (EventGridEvent eventGridEvent in eventGridEvents)
        {
            logger.LogInformation("Got malware scan event of type {EventType} with data: {eventData}", eventGridEvent.EventType, eventGridEvent.Data.ToString());
            if (eventGridEvent.TryGetSystemEventData(out object eventData))
            {
                if (eventData is SubscriptionValidationEventData subscriptionValidationEventData)
                {
                    var responseData = new
                    {
                        ValidationResponse = subscriptionValidationEventData.ValidationCode
                    };
                    return new OkObjectResult(responseData);
                }
            }
            else if (eventGridEvent.EventType == "Microsoft.Security.MalwareScanningResult")
            {
                string jsonString = eventGridEvent.Data.ToString();
                ScanResultData? result = JsonConvert.DeserializeObject<ScanResultData>(jsonString);
                if (result is null)
                {
                    throw new InvalidOperationException("Failed to deserialize malware scan result data");
                }
                var commandResult = await handler.Process(result, null, cancellationToken);
                return commandResult.Match(
                    Ok,
                    Problem
                );

            }
        }

        return Ok();
    }
    private ActionResult Problem(Error error) => ProblemDetailsHelper.ToProblemResult(error);
}
