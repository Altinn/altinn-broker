
using Altinn.Broker.Application;
using Altinn.Broker.Core.Domain;
using Altinn.Broker.Core.Repositories;
using Altinn.Broker.Helpers;

using Azure.Messaging.EventGrid;
using Azure.Messaging.EventGrid.SystemEvents;

using Microsoft.AspNetCore.Mvc;

using Newtonsoft.Json;

using OneOf;

namespace Altinn.Broker.Webhooks.Controllers
{
    [ApiController]
    [Route("broker/api/v1/webhooks/malwarescanresults")]
    public class MalwareScanResultsController : Controller
    {
        private readonly IIdempotencyEventRepository _idempotencyEventRepository;
        private readonly ILogger<MalwareScanResultsController> _logger;

        public MalwareScanResultsController(IIdempotencyEventRepository idempotencyEventRepository, ILogger<MalwareScanResultsController> logger)
        {
            _idempotencyEventRepository = idempotencyEventRepository;
            _logger = logger;
        }

        [HttpPost]
        [Consumes("application/json")]
        public async Task<ActionResult> ProcessMalwareScanResult([FromServices] MalwareScanningResultHandler handler, CancellationToken cancellationToken)
        {
            BinaryData events = await BinaryData.FromStreamAsync(this.Request.Body);
            EventGridEvent[] eventGridEvents = EventGridEvent.ParseMany(events);
            foreach (EventGridEvent eventGridEvent in eventGridEvents)
            {
                _logger.LogInformation("Got malware scan event of type {EventType} with data: {eventData}", eventGridEvent.EventType, eventGridEvent.Data.ToString());
                if (eventGridEvent.TryGetSystemEventData(out object eventData))
                {
                    if (eventData is SubscriptionValidationEventData subscriptionValidationEventData)
                    {
                        // TODO: validate that eventGridEvent WebHook subscription is actually from an Altinn Azure Defender EventGrid
                        var responseData = new
                        {
                            ValidationResponse = subscriptionValidationEventData.ValidationCode
                        };
                        return new OkObjectResult(responseData);
                    }
                }
                else if (eventGridEvent.EventType == "Microsoft.Security.MalwareScanningResult")
                {
                    string jsonString = eventGridEvent.Data.ToString();
                    ScanResultData result = JsonConvert.DeserializeObject<ScanResultData>(jsonString);
                    var processFunction = new Func<Task<OneOf<Task, Error>>>(() => handler.Process(result, cancellationToken));
                    var commandResult = await IdempotencyEventHelper.ProcessEvent(result.ETag, processFunction, _idempotencyEventRepository, cancellationToken);
                    return commandResult.Match(
                        Ok,
                        Problem
                    );

                }
            }

            return Ok();
        }
        private ObjectResult Problem(Error error) => Problem(detail: error.Message, statusCode: (int)error.StatusCode);
    }
}
